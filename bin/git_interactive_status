#!/bin/bash

# A script to stage or unstage files in Git interactively.

preview_cmd="
    case {} in
        '??'*|'A '*)
            bat --style=numbers --color=always {2}
            ;;
        ' D'*|D*)
            git show @^:{2} | bat --style=numbers --color=always --file-name {2}
            ;;
        MM*)
            echo ó°•œ Staged
            git diff --cached --color=always {2} | delta
            echo; echo ó°•› Unstaged
            git diff --color=always {2} | delta
            ;;
        ' '*)
            git diff --color=always {2} | delta
            ;;
        *)
            git diff --cached --color=always {2} | delta
            ;;
    esac
"

fzf_options=(
    --multi
    --no-sort
    --track
    --tmux=90%,border-native
    --preview="$preview_cmd"
    --bind='start:ignore'
    --bind='h:become(git hi)'
    --bind='enter:execute(git add {+2})+accept'
    --bind='e:execute(nvim {+2})+reload-sync(git status-i-list)'
    --bind='a:execute-silent(git add {+2})+reload-sync(git status-i-list)'
    --bind='A:execute-silent(git add -u)+reload-sync(git status-i-list)'
    --bind='p:execute(clear; git add --patch {+2})+reload-sync(git status-i-list)'
    --bind='u:execute-silent(git reset -- {+2})+reload-sync(git status-i-list)'
    --bind='U:execute-silent(git reset .)+reload-sync(git status-i-list)'
    --bind='o:execute-silent(git checkout {+2})+reload-sync(git status-i-list)'
    --bind='D:execute(git diff)'
    --bind='C:execute(git diff --cached)'
    --bind='N:execute(bat $(git ls-files --others --exclude-standard))'
    --bind='z:execute(zsh)+reload-sync(git status-i-list)'
)

git status-i-list | fzf "${fzf_options[@]}" > /dev/null
git status
