#!/bin/bash

# A script to filter and operate Git logs interactively.

main() {
    cmd="$1"
    shift
    case "$cmd" in
        popup) popup "$@" ;;
        run) run "$@" ;;
        _list) _list "$@" ;;
        _diff) _diff "$@" ;;
        _menu) _menu "$@" ;;
        *)
            echo 'specify valid command'
            exit 1
    esac
}

preview_cmd="
    case {} in
        '󰍟'*)
            ;;
        *)
            git show -m {2} | delta
            ;;
    esac
"
copy_cmd=$(command -v wl-copy > /dev/null 2>&1 && echo wl-copy || echo pbcopy)
files_and_dirs_in_git="(git ls-files; git ls-tree -r -d --name-only @ | awk '{print \$0\"/\"}')"
fzf_options=(
    --multi
    --no-sort
    --track
    --nth 2..
    --preview="$preview_cmd"
    --bind='start:ignore'
    --bind='s:become(git_interactive_status popup)'
    --bind='z:execute(zsh)+reload-sync(git_interactive_history _list)'
    --bind="m:execute(git_interactive_history _menu)"
    --bind='?:execute(bat $(command -v git_interactive_history))'

    --bind="y:become(echo {+2} | tr -d '\n' | $copy_cmd)"
    --bind="D:execute(git_interactive_history _diff {+2})"
    --bind="d:execute(git_interactive_diff run {+2})"
    --bind='b:execute(git rebase -i {2}^ || zsh)+reload-sync(git_interactive_history _list)'
    --bind='A:execute(git rebase --autosquash {2}^)+reload-sync(git_interactive_history _list)'
    --bind='R:become(git reset --soft {2}^ && git status)'
    --bind='F:execute(git commit --fixup {2})+reload-sync(git_interactive_history _list)'
    --bind='S:execute(git commit --squash {2})+reload-sync(git_interactive_history _list)'
)

popup() {
    fzf_options+=(--tmux=90%,border-native)
    run "$@"
}

run() {
    # Show the number of unstaged files.
    if ! git diff --quiet; then
        local n_unstaged_files=$(git status --porcelain | grep -v '^??' | wc -l | tr -d ' ')
        fzf_options+=(--header="! $n_unstaged_files Unstaged files")
    fi
    _list "$@" | fzf "${fzf_options[@]}"
}

_list() {
    git re -500 --color=always "$@" | nl -w 3 -s ' '
}

_diff() {
    if [[ $# -eq 1 ]]; then
        git show -m $1 | LESS='-Ri' delta --paging always
    else
        local latest=$1
        local oldest=${@: -1}
        git diff $oldest..$latest | LESS='-Ri' delta --paging always
    fi
}

_menu() {
    local result=`
        (
            echo '[1] Switch branch'
            echo '[2] Filter by files'
        ) | fzf --header=Menu --bind='start:ignore'
    `
    if [ -z "$result" ]; then
        return
    fi
    case $result in
        '[1]'*)
            local branch=`
                git branch -a --format='%(refname:short)' | \
                fzf --header='Select Branch' --bind='start:ignore'
            `
            if [ -n "$branch" ]; then
                git_interactive_history run "$branch"
                return
            fi
            ;;
        '[2]'*)
            local files=`
                (git ls-files; git ls-tree -r -d --name-only @ | awk '{print $0"/"}') | \
                fzf --multi --bind='start:ignore'
            `
            if [ -n "$files" ]; then
                echo "$files" | xargs git_interactive_history run --
                return
            fi
            ;;
    esac
    git_interactive_history _menu "$@"
}

main "$@"
