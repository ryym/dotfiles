#!/bin/bash

# A script to filter and operate Git logs interactively.

main() {
    cmd="$1"
    shift
    case "$cmd" in
        popup) popup "$@" ;;
        run) run "$@" ;;
        _list) _list "$@" ;;
        _diff) _diff "$@" ;;
        _diff_i) _diff_i "$@" ;;
        _menu) _menu "$@" ;;
        *)
            echo 'specify valid command'
            exit 1
    esac
}

preview_cmd="
    case {} in
        'ó°Ÿ'*)
            ;;
        *)
            git -c color.ui=always show --stat --patch -m {2} | delta
            ;;
    esac
"
files_and_dirs_in_git="(git ls-files; git ls-tree -r -d --name-only @ | awk '{print \$0\"/\"}')"
fzf_options=(
    --multi
    --no-sort
    --track
    --nth 2..
    --preview="$preview_cmd"
    --bind='start:ignore'
    --bind='s:become(git_interactive_status popup)'
    --bind='z:execute(zsh)+reload-sync(git_interactive_history _list)'
    --bind="m:execute(git_interactive_history _menu)"
    --bind='?:execute(bat $(command -v git_interactive_history))'

    --bind="y:execute-silent(echo {+2} | tr -d '\n' | ccopy)"
    --bind="D:execute(git_interactive_history _diff {+2})"
    --bind='d:execute(git_interactive_history _diff_i {+2})'
    --bind='b:execute(git rebase -i {2}^ || zsh)+reload-sync(git_interactive_history _list)'
    --bind='A:execute(git rebase --autosquash {2}^)+reload-sync(git_interactive_history _list)'
    --bind='R:become(git reset --soft {2}^ && git status)'
    --bind='F:execute(git commit --fixup {2})+reload-sync(git_interactive_history _list)'
    --bind='S:execute(git commit --squash {2})+reload-sync(git_interactive_history _list)'

    # Make exit code 0 for these cancel keys.
    --expect='q,ctrl-g'
)

popup() {
    fzf_options+=(--tmux=90%,border-native)
    run "$@"
}

run() {
    _list "$@" | fzf "${fzf_options[@]}" > /dev/null
}

_list() {
    git re -500 --color=always "$@" | nl -w 3 -s ' '
}

_diff() {
    if [[ $# -eq 1 ]]; then
        git -c color.ui=always show --stat --patch -m $1 | delta --pager 'less -+F'
    else
        local latest=$1
        local oldest=${@: -1}
        git diff $oldest..$latest | delta --pager 'less -+F'
    fi
}

_diff_i() {
    if [[ $# -eq 1 ]]; then
        git_interactive_show run "$@"
    else
        git_interactive_diff run "$@"
    fi
}

_menu() {
    local result=`
        (
            echo '[1] Switch branch'
            echo '[2] Filter by files'
        ) | fzf --header=Menu --bind='start:ignore'
    `
    if [ -z "$result" ]; then
        return
    fi
    case $result in
        '[1]'*)
            local branch=`
                git branch -a --format='%(refname:short)' | \
                fzf --header='Select Branch' --bind='start:ignore'
            `
            if [ -n "$branch" ]; then
                git_interactive_history run "$branch"
                return
            fi
            ;;
        '[2]'*)
            local files=`
                (git ls-files; git ls-tree -r -d --name-only @ | awk '{print $0"/"}') | \
                fzf --multi --bind='start:ignore'
            `
            if [ -n "$files" ]; then
                echo "$files" | xargs git_interactive_history run --
                return
            fi
            ;;
    esac
    git_interactive_history _menu "$@"
}

main "$@"
