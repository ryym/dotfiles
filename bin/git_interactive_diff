#!/bin/bash

# A script to view Git diff per file interactively.

main() {
    cmd="$1"
    shift
    case "$cmd" in
        popup) popup "$@" ;;
        run) run "$@" ;;
        *)
            echo 'specify valid command'
            exit 1
    esac
}

fzf_options=(
    --bind='start:ignore'
)

popup() {
    fzf_options+=(--tmux=90%,border-native)
    run "$@"
}

run() {
    fzf_options+=(
         --header="$*"
        --preview="git diff $* -- {2} | delta"
        --bind="A:execute(git diff $* | delta --pager 'less -+F')"
        --bind="v:execute(git diff $* -- {2} | delta --pager 'less -+F')"
    )
    git diff --name-status "$@" | awk '{print $1 " " $2}' | fzf "${fzf_options[@]}"
}

main "$@"
