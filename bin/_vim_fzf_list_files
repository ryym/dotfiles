#!/usr/bin/env sh

# A script called from Vim's fzf utility. See: ./dotfiles/vim/autoload/my/plug/fzf.vim

main() {
    cmd="$1"
    shift
    case "$cmd" in
        buffers) buffers "$@" ;;
        buffers_and_files) buffers_and_files "$@" ;;
        fd_formatted) fd_formatted "$@" ;;
        *)
            echo 'specify valid command'
            exit 1
    esac
}

# Format buffers passed as arguments.
buffers() {
    for filepath in "$@"; do
        format 33 ':' "$(basename "$filepath")" "$(dirname "$filepath")"
    done
}

# - list all files as well as currently open buffers in Vim
# - list buffers first and list other files excluding buffers
# Buffers are passed as arguments.
buffers_and_files() {
    excludes=('-e' '_')
    for filepath in "$@"; do
        format 33 ':' "$(basename "$filepath")" "$(dirname "$filepath")"
        excludes+=("-e" "$(format 0 '=' "$(basename "$filepath")" "$(dirname "$filepath")")")
    done
    fd --hidden -tf -tl -E .git --format "$(format 0 '=' '{/}' '{//}')" | grep -v -F -x "${excludes[@]}"
}

fd_formatted() {
    fd --hidden -tf -tl -E .git --format "$(format 0 '=' '{/}' '{//}')" "$@"
}

format() {
    color="$1"
    mark="$2"
    base="$3"
    dir="$4"
    # e.g. format 33 ':' 'index.js' 'src/auth' => ": index.js src.auth/index.js" with nice coloring
    printf "[38;5;245m%s[0m [%sm%s[0m [38;5;245m%s/[38;5;240m%s[0m\n" "$mark" "$color" "$base" "$dir" "$base"
}

main "$@"
